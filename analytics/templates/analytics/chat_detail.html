{% extends 'analytics/base.html' %}

{% block title %}Chat: {{ chat.participant1.display_name }} â†” {{ chat.participant2.display_name }} - CloakTalk Analytics{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb">
    <a href="{% url 'analytics:dashboard' %}">Dashboard</a> /
    <a href="{% url 'analytics:users_list' %}">Users</a> /
    Chat Details
</div>
{% endblock %}

{% block content %}
<div class="card">
    <h2 style="margin-bottom: 1rem; color: #667eea;">Chat Information</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
        <div>
            <table style="box-shadow: none;">
                <tr>
                    <td><strong>Chat ID:</strong></td>
                    <td>{{ chat.id }}</td>
                </tr>
                <tr>
                    <td><strong>College:</strong></td>
                    <td>{{ chat.college.name }}</td>
                </tr>
                <tr>
                    <td><strong>Status:</strong></td>
                    <td>
                        {% if chat.is_active %}
                            <span class="badge">Active</span>
                        {% else %}
                            <span class="badge inactive">Inactive</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td><strong>Created:</strong></td>
                    <td>{{ chat.created_at|date:"F d, Y H:i" }}</td>
                </tr>
                <tr>
                    <td><strong>Duration:</strong></td>
                    <td>{{ chat_stats.chat_duration }}</td>
                </tr>
            </table>
        </div>
        <div>
            <h3 style="margin-bottom: 1rem; color: #667eea;">Participants</h3>
            <div style="display: flex; gap: 2rem;">
                <div>
                    <h4>
                        <a href="{% url 'analytics:user_detail' chat.participant1.pk %}">
                            {{ chat.participant1.display_name }}
                        </a>
                    </h4>
                    <p style="font-size: 0.9rem; color: #666;">{{ chat.participant1.email }}</p>
                    <p style="font-size: 0.9rem;">Messages: <strong>{{ chat_stats.participant1_messages }}</strong></p>
                </div>
                <div style="display: flex; align-items: center; color: #667eea; font-size: 1.5rem;">â†”</div>
                <div>
                    <h4>
                        <a href="{% url 'analytics:user_detail' chat.participant2.pk %}">
                            {{ chat.participant2.display_name }}
                        </a>
                    </h4>
                    <p style="font-size: 0.9rem; color: #666;">{{ chat.participant2.email }}</p>
                    <p style="font-size: 0.9rem;">Messages: <strong>{{ chat_stats.participant2_messages }}</strong></p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <span class="stat-number">{{ chat_stats.total_messages }}</span>
        <div class="stat-label">Total Messages</div>
    </div>
    <div class="stat-card">
        <span class="stat-number">{{ chat_stats.participant1_messages }}</span>
        <div class="stat-label">{{ chat.participant1.display_name }}</div>
    </div>
    <div class="stat-card">
        <span class="stat-number">{{ chat_stats.participant2_messages }}</span>
        <div class="stat-label">{{ chat.participant2.display_name }}</div>
    </div>
    <div class="stat-card">
        <span class="stat-number">{{ chat_stats.system_messages }}</span>
        <div class="stat-label">System Messages</div>
    </div>
</div>

<div class="card">
    <div class="controls">
        <h2 style="margin: 0; color: #667eea;">Messages ({{ chat_stats.total_messages }})</h2>

        <div class="sort-controls">
            <form method="GET" id="sortForm">
                <select name="sort" onchange="document.getElementById('sortForm').submit()">
                    <option value="created_at" {% if current_sort == 'created_at' %}selected{% endif %}>Timestamp</option>
                </select>
                <select name="order" onchange="document.getElementById('sortForm').submit()">
                    <option value="asc" {% if current_order == 'asc' %}selected{% endif %}>Oldest First</option>
                    <option value="desc" {% if current_order == 'desc' %}selected{% endif %}>Newest First</option>
                </select>
            </form>
        </div>
    </div>

    <div style="max-height: 600px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 1rem;">
        {% for message in messages %}
        <div style="margin-bottom: 1rem; padding: 0.75rem; border-radius: 8px; {% if message.message_type == 'system' %}background: #f8f9fa; border-left: 4px solid #6c757d;{% elif message.sender == chat.participant1 %}background: #e3f2fd; border-left: 4px solid #2196f3;{% else %}background: #f3e5f5; border-left: 4px solid #9c27b0;{% endif %}">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                <div style="font-weight: 600; {% if message.message_type == 'system' %}color: #6c757d; font-style: italic;{% elif message.sender == chat.participant1 %}color: #1976d2;{% else %}color: #7b1fa2;{% endif %}">
                    {% if message.message_type == 'system' %}
                        System
                    {% else %}
                        {% if message.sender == chat.participant1 %}
                            {{ chat.participant1.display_name }}
                        {% else %}
                            {{ chat.participant2.display_name }}
                        {% endif %}
                    {% endif %}
                </div>
                <div style="font-size: 0.8rem; color: #666;">
                    {{ message.created_at|date:"M d, Y H:i:s" }}
                </div>
            </div>
            <div style="{% if message.message_type == 'system' %}font-style: italic;{% endif %}">
                {{ message.content|linebreaks }}
            </div>
        </div>
        {% empty %}
        <div style="text-align: center; color: #666; padding: 2rem;">
            No messages in this chat
        </div>
        {% endfor %}
    </div>

    {% if messages.has_other_pages %}
    <div class="pagination">
        {% if messages.has_previous %}
            <a href="?page=1&sort={{ current_sort }}&order={{ current_order }}">First</a>
            <a href="?page={{ messages.previous_page_number }}&sort={{ current_sort }}&order={{ current_order }}">Previous</a>
        {% endif %}

        <span class="current">
            Page {{ messages.number }} of {{ messages.paginator.num_pages }}
        </span>

        {% if messages.has_next %}
            <a href="?page={{ messages.next_page_number }}&sort={{ current_sort }}&order={{ current_order }}">Next</a>
            <a href="?page={{ messages.paginator.num_pages }}&sort={{ current_sort }}&order={{ current_order }}">Last</a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}
