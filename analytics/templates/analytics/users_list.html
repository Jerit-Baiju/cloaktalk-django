{% extends 'analytics/base.html' %}

{% block title %}Users - CloakTalk Analytics{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb">
    <a href="{% url 'analytics:dashboard' %}">Dashboard</a> / Users
</div>
{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-card">
        <span class="stat-number">{{ total_users }}</span>
        <div class="stat-label">Total Users</div>
    </div>
    <div class="stat-card">
        <span class="stat-number">{{ verified_users }}</span>
        <div class="stat-label">Verified Users</div>
    </div>
    <div class="stat-card">
        <span class="stat-number">{{ total_chats }}</span>
        <div class="stat-label">Total Chats</div>
    </div>
    <div class="stat-card">
        <span class="stat-number">{{ total_messages }}</span>
        <div class="stat-label">Total Messages</div>
    </div>
</div>

<div class="card">
    <div class="controls">
        <form method="GET" class="search-form">
            <input type="text" name="search" placeholder="Search users..." value="{{ search_query }}">
            <input type="hidden" name="sort" value="{{ current_sort }}">
            <input type="hidden" name="order" value="{{ current_order }}">
            <button type="submit" class="btn">Search</button>
        </form>

        <div class="sort-controls">
            <form method="GET" id="sortForm">
                <input type="hidden" name="search" value="{{ search_query }}">
                <select name="sort" onchange="document.getElementById('sortForm').submit()">
                    <option value="created_at" {% if current_sort == 'created_at' %}selected{% endif %}>Join Date</option>
                    <option value="first_name" {% if current_sort == 'first_name' %}selected{% endif %}>First Name</option>
                    <option value="last_name" {% if current_sort == 'last_name' %}selected{% endif %}>Last Name</option>
                    <option value="username" {% if current_sort == 'username' %}selected{% endif %}>Username</option>
                    <option value="email" {% if current_sort == 'email' %}selected{% endif %}>Email</option>
                    <option value="chat_count" {% if current_sort == 'chat_count' %}selected{% endif %}>Chat Count</option>
                    <option value="message_count" {% if current_sort == 'message_count' %}selected{% endif %}>Message Count</option>
                    <option value="latest_activity" {% if current_sort == 'latest_activity' %}selected{% endif %}>Latest Activity</option>
                    <option value="is_verified" {% if current_sort == 'is_verified' %}selected{% endif %}>Verification Status</option>
                </select>
                <select name="order" onchange="document.getElementById('sortForm').submit()">
                    <option value="desc" {% if current_order == 'desc' %}selected{% endif %}>Descending</option>
                    <option value="asc" {% if current_order == 'asc' %}selected{% endif %}>Ascending</option>
                </select>
            </form>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>User</th>
                <th>College</th>
                <th>Chats</th>
                <th>Messages</th>
                <th>Status</th>
                <th>Latest Activity</th>
                <th>Joined</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>
                    <div>
                        <strong>{{ user.first_name|default:user.username }}</strong>
                        <div style="font-size: 0.8rem; color: #666;">{{ user.email }}</div>
                        <div style="font-size: 0.8rem; color: #666;">@{{ user.username }}</div>
                    </div>
                </td>
                <td>{{ user.college.name|default:"N/A" }}</td>
                <td>
                    <span class="stat-number" style="font-size: 1.2rem;">{{ user.chat_count|default:0 }}</span>
                </td>
                <td>
                    <span class="stat-number" style="font-size: 1.2rem;">{{ user.message_count|default:0 }}</span>
                </td>
                <td>
                    {% if user.is_verified %}
                        <span class="badge">Verified</span>
                    {% else %}
                        <span class="badge unverified">Unverified</span>
                    {% endif %}
                    {% if user.is_superuser %}
                        <span class="badge" style="background: #17a2b8;">Admin</span>
                    {% endif %}
                </td>
                <td>
                    {% if user.latest_activity %}
                        {{ user.latest_activity|date:"M d, Y H:i" }}
                    {% else %}
                        <span style="color: #666;">Never</span>
                    {% endif %}
                </td>
                <td>{{ user.created_at|date:"M d, Y" }}</td>
                <td>
                    <a href="{% url 'analytics:user_detail' user.pk %}" class="btn btn-sm">View Details</a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8">No users found</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if is_paginated %}
    <div class="pagination">
        {% if page_obj.has_previous %}
            <a href="?page=1&sort={{ current_sort }}&order={{ current_order }}&search={{ search_query }}">First</a>
            <a href="?page={{ page_obj.previous_page_number }}&sort={{ current_sort }}&order={{ current_order }}&search={{ search_query }}">Previous</a>
        {% endif %}

        <span class="current">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&sort={{ current_sort }}&order={{ current_order }}&search={{ search_query }}">Next</a>
            <a href="?page={{ page_obj.paginator.num_pages }}&sort={{ current_sort }}&order={{ current_order }}&search={{ search_query }}">Last</a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}
